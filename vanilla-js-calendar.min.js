class VanillaCalendar {
    constructor(selector, options) {
        this.HTMLElement = document.querySelector(selector);
        if (!this.HTMLElement) return;
        this.date = new Date();
        this.selectedDate = null;
        this.onSelect = options?.actions?.clickDay;
        this.markers = options?.popups || {}; // { 'YYYY-MM-DD': true }
        this.init();
    }

    init() {
        this.render();
    }

    update() {
        this.render();
    }

    render() {
        this.HTMLElement.innerHTML = '';
        this.createHeader();
        this.createWeek();
        this.createDays();
    }

    createHeader() {
        const header = document.createElement('div');
        header.className = 'vanilla-calendar-header';

        const prevBtn = document.createElement('div');
        prevBtn.className = 'vanilla-calendar-arrow vanilla-calendar-arrow_prev';
        prevBtn.onclick = () => this.changeMonth(-1);

        const content = document.createElement('div');
        content.className = 'vanilla-calendar-header__content';
        const monthName = this.date.toLocaleString('pt-BR', { month: 'long' });
        content.innerText = `${monthName} ${this.date.getFullYear()}`;

        const nextBtn = document.createElement('div');
        nextBtn.className = 'vanilla-calendar-arrow vanilla-calendar-arrow_next';
        nextBtn.onclick = () => this.changeMonth(1);

        header.appendChild(prevBtn);
        header.appendChild(content);
        header.appendChild(nextBtn);
        this.HTMLElement.appendChild(header);
    }

    createWeek() {
        const week = document.createElement('div');
        week.className = 'vanilla-calendar-week';
        ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(day => {
            const el = document.createElement('div');
            el.className = 'vanilla-calendar-week__day';
            el.innerText = day;
            week.appendChild(el);
        });
        this.HTMLElement.appendChild(week);
    }

    createDays() {
        const daysGrid = document.createElement('div');
        daysGrid.className = 'vanilla-calendar-days';
        
        const year = this.date.getFullYear();
        const month = this.date.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Dias vazios
        for (let i = 0; i < firstDay; i++) {
            daysGrid.appendChild(document.createElement('div'));
        }

        // Dias do mês
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'vanilla-calendar-day';
            dayEl.innerText = i;
            
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            
            // Marcador de Hoje
            const today = new Date();
            if (today.toDateString() === new Date(year, month, i).toDateString()) {
                dayEl.classList.add('vanilla-calendar-day__btn_today');
            }

            // Selecionado
            if (this.selectedDate === dateStr) {
                dayEl.classList.add('vanilla-calendar-day__btn_selected');
            }

            // Marcador de Dados (Bolinha)
            if (this.markers[dateStr]) {
                const marker = document.createElement('div');
                marker.className = 'vanilla-calendar-day-marker';
                dayEl.appendChild(marker);
            }

            dayEl.onclick = () => {
                this.selectedDate = dateStr;
                this.render();
                if (this.onSelect) {
                    // Simula o evento esperado pelo código principal
                    this.onSelect(null, { selectedDates: [dateStr] });
                }
            };

            daysGrid.appendChild(dayEl);
        }

        this.HTMLElement.appendChild(daysGrid);
    }

    changeMonth(step) {
        this.date.setMonth(this.date.getMonth() + step);
        this.render();
    }
}
// Exporta para o escopo global
window.VanillaCalendar = VanillaCalendar;